name: ZIL Tooling Space Builder

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Memungkinkan eksekusi manual

jobs:
  build-tooling:
    runs-on: macos-latest
    
    steps:
      - name: Checkout ZIL Repository
        uses: actions/checkout@v4

      - name: Setup Swift & Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0' # Memastikan SDK iOS 18 tersedia

      - name: Install Dependencies
        run: |
          brew install ldid
          # Menyiapkan folder output sesuai struktur ZIL
          mkdir -p tools/bin

      # --- 1. BUILD TOYBOX ---
      - name: Fetch & Build Toybox
        run: |
          git clone https://github.com/landley/toybox.git
          cd toybox
          # Konfigurasi cross-compile untuk iOS
          # Kita menggunakan target arm64-apple-ios18.0
          make macos_defconfig
          PREFIX=../tools/bin/ LDFLAGS="-arch arm64 -isysroot $(xcrun --sdk iphoneos --show-sdk-path) -miphoneos-version-min=18.0" \
          CFLAGS="-arch arm64 -isysroot $(xcrun --sdk iphoneos --show-sdk-path) -miphoneos-version-min=18.0" \
          make toybox
          cp toybox ../tools/bin/toybox_brutal.bin
          cd ..

      # --- 2. BUILD ELLEKIT ---
      - name: Fetch & Build ElleKit
        run: |
          git clone --recursive https://github.com/mcaollo/ElleKit.git
          cd ElleKit
          # Kompilasi ElleKit menggunakan Swift Package Manager untuk target iOS
          swift build -c release --triple arm64-apple-ios18.0
          cp .build/release/libElleKit.dylib ../tools/bin/ellekit.dylib
          cd ..

      # --- 3. SIGNING & ENTITLEMENTS ---
      - name: Apply Entitlements & Codesign
        run: |
          # Menggunakan file entitlements.xml yang telah kita buat sebelumnya
          # ldid akan menyuntikkan izin sandbox escape dan platform-binary
          ldid -Score/executor/entitlements.xml tools/bin/toybox_brutal.bin
          ldid -Score/executor/entitlements.xml tools/bin/ellekit.dylib

      # --- 4. CDHASH EXTRACTION ---
      - name: Run ZIL CDHash Extractor
        run: |
          # Menjalankan skrip Python yang sudah dirombak total (Mach-O Parser)
          python3 tools/build_cdhash_list.py

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zil-tooling-space
          path: |
            tools/bin/
            core/executor/src/trusted_hashes.rs
